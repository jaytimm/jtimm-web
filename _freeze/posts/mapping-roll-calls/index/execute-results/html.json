{
  "hash": "3070344fddbb893325059056ce28c1bb",
  "result": {
    "markdown": "---\ntitle: \"mapping congressional roll calls\"\ndate: \"2020-09-28\"\ndescription: \"A ggplot reference for performing some common geo-spatial analyses\"\ncategories: [american politics, geospatial]\n  \nbibliography: /home/jtimm/pCloudDrive/GitHub/jtimm_web/biblio.bib\nimage: mapping-roll-calls.png\n\nformat:\n  html:\n    toc: true\n    toc-depth: 2\n    number-sections: true\n---\n\n\n> Methods for mapping with R & `ggplot`, in the context of visualizing historical roll calls from the US House of Representatives. Roll call data accessed via [VoteView](https://voteview.com/about) and the [RVoteview](https://github.com/voteview/Rvoteview) package [@jeffrey2020voteview]; shapefiles for historical US Congressional Districts downloaded from the [Political Science Dept \\@ UCLA](http://cdmaps.polisci.ucla.edu/) [@lewis2013digital]. Visual summary via the `patchwork` package.\n\n> Here we use as examples the **Voting Rights Act of 1965** and the **Bayh--Celler amendment** (circa 1969), a proposed amendment that would have replaced the Electoral College with a system based on the popular vote.\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#  devtools::install_github(\"voteview/Rvoteview\")\nlibrary(patchwork)\nlibrary(tidyverse) \nlibrary(tigris); options(tigris_use_cache = TRUE, tigris_class = \"sf\")\nnonx <- c('78', '69', '66', '72', '60', '15', '02')\n\nstates <- tigris::states(cb = TRUE) %>%\n  data.frame() %>%\n  select(STATEFP, STUSPS) %>%\n  rename(state_abbrev = STUSPS)\n```\n:::\n\n\n## Historical urban centers\n\nMost populous US cities by decade, from 1790 to 2010; scraped from Wikipedia. For zooming-in on district roll call results for, eg, the ten most populous cities during a given congress.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwiki <- 'https://en.wikipedia.org/wiki/List_of_most_populous_cities_in_the_United_States_by_decade'\n\ndecade <- seq(from = 1780, to = 2010, by = 10)\npops_list <- xml2::read_html(wiki) %>% \n  rvest::html_nodes(\"table\") %>%\n  rvest::html_table(fill = TRUE)\n\npops <- lapply(2:24, function(x) {\n  y <- pops_list[[x]] %>%\n    select(1:4) %>%\n    mutate(decade = decade[x])\n  \n  colnames(y) <- c('rank', 'city', 'state', 'pop', 'decade')\n  return(y) }) %>%\n  bind_rows() %>%\n  mutate(pop = as.integer(gsub(\"[^0-9]\", \"\", pop)))\n```\n:::\n\n\n**Most populated US cities circa 1800**:\n\n\n::: {.cell}\n::: {.cell-output-display}\n| rank|city               |state          |   pop| decade|\n|----:|:------------------|:--------------|-----:|------:|\n|    1|New York           |New York       | 60514|   1800|\n|    2|Philadelphia       |Pennsylvania   | 41220|   1800|\n|    3|Baltimore          |Maryland       | 26514|   1800|\n|    4|Boston             |Massachusetts  | 24937|   1800|\n|    5|Charleston         |South Carolina | 18824|   1800|\n|    6|Northern Liberties |Pennsylvania   | 10718|   1800|\n|    7|Southwark          |Pennsylvania   |  9621|   1800|\n|    8|Salem              |Massachusetts  |  9457|   1800|\n|    9|Providence         |Rhode Island   |  7614|   1800|\n|   10|Norfolk            |Virginia       |  6926|   1800|\n:::\n:::\n\n\n## Historical congressional districts\n\nAgain, via the folks at the [Political Science Dept \\@ UCLA](http://cdmaps.polisci.ucla.edu/). The Voting Rights Act of 1965 was passed during the 89th congress; a local copy of the shapefile for this congress is loaded below.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfname <- 'districts089'\n\ncd_sf <- sf::st_read(dsn = paste0(cd_directory, fname), \n                    layer = fname, \n                    quiet = TRUE) %>%\n  mutate(STATEFP = substr(ID, 2, 3),\n         district_code = as.numeric(substr(ID, 11, 12))) %>%\n  left_join(states, by = \"STATEFP\") %>%\n  filter(!STATEFP %in% nonx) %>%\n  select(STATEFP, state_abbrev, district_code) \n```\n:::\n\n\n## VoteView roll call data\n\nDownloading roll call data for a specific bill via `RVoteview` requires a bit of trial and error; different bill versions and vote types complicate things for the layman.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvra <- Rvoteview::voteview_search('(\"VOTING RIGHTS ACT OF 1965\") AND (congress:89) \n                                  AND (chamber:house)') %>%\n                                  filter( date == '1965-07-09') %>%\n  janitor::clean_names()\n\nvotes <- Rvoteview::voteview_download(vra$id)\nnames(votes) <- gsub('\\\\.', '_', names(votes))\n```\n:::\n\n\n\n\n**A quick re-structure** of the roll call output:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbig_votes <- votes$legis_long_dynamic %>%\n  left_join(votes$votes_long, by = c(\"id\", \"icpsr\")) %>%\n  filter(!grepl('POTUS', cqlabel)) %>%\n  group_by(state_abbrev) %>%\n  mutate(n = length(district_code)) %>%\n  ungroup() %>%\n  mutate(avote = case_when(vote %in% c(1:3) ~ 'Yea',\n                           vote %in% c(4:6) ~ 'Nay',\n                           vote %in% c(7:9) ~ 'Not Voting'),\n         \n         party_code = case_when(party_code == 100 ~ 'Dem',\n                                party_code == 200 ~ 'Rep' ), \n         Party_Member_Vote = paste0(party_code, ': ', avote),\n         \n         ## fix at-large -- \n         district_code = ifelse(district_code %in% c(98, 99), 0, district_code),\n         district_code = ifelse(n == 1 & district_code == 1, 0, district_code),\n         district_code = as.integer(district_code)) %>%\n  select(-n)\n#Members who represent historical “at-large” districts are \n##assigned 99, 98, or 1 in various circumstances. Per VoteView.\n```\n:::\n\n\n## Roll call stats\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbig_votes$Party_Member_Vote <- factor(big_votes$Party_Member_Vote)\nbig_votes$Party_Member_Vote <- \n  factor(big_votes$Party_Member_Vote, \n         levels(big_votes$Party_Member_Vote)[c(3,6,1,4,2,5)])\n```\n:::\n\n\n### Results\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary <- big_votes %>%\n  group_by(party_code, avote) %>%\n  count() %>%\n  spread(avote, n) %>%\n  janitor::adorn_totals(where = c('row', 'col')) %>%\n  rename(Party = party_code,\n         NV = `Not Voting`) %>%\n  select(Party, Yea, Nay, NV, Total)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Roll call results for the VRA\n\n|Party | Yea| Nay| NV| Total|\n|:-----|---:|---:|--:|-----:|\n|Dem   | 224|  65|  4|   293|\n|Rep   | 112|  23|  5|   140|\n|Total | 336|  88|  9|   433|\n:::\n:::\n\n\n### By party affiliation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nroll <- big_votes %>% \n  group_by(Party_Member_Vote) %>%\n  count() %>%\n  ungroup() %>%\n  rename(Vote = Party_Member_Vote) \n\nrsum <- roll %>% \n  ggplot(aes(x=Vote, y=n, fill= Vote, label = n)) +\n    geom_col(width=.65, color = 'lightgray') +  \n    geom_text(size = 2.5) +\n    wnomadds::scale_color_rollcall(aesthetics = c(\"fill\")) +\n    scale_x_discrete(limits = rev(levels(roll$Vote)))+\n    coord_flip() +\n  ylim (0, 240) +\n    theme_minimal() + \n      theme(axis.title.x=element_blank(),\n            axis.text.x=element_blank(),\n            axis.title.y=element_blank(),\n            #axis.text.y=element_blank(),\n            legend.position = 'none')\n\nrsum + ggtitle(vra$short_description)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### By congressional district\n\n\n::: {.cell preview='true'}\n\n```{.r .cell-code}\ncd_sf_w_rolls <- cd_sf %>% \n  left_join(big_votes, by = c(\"state_abbrev\", \"district_code\")) \n\nmain1 <- cd_sf_w_rolls %>%\n  ggplot() + \n  geom_sf(aes(fill = Party_Member_Vote), \n          color = 'white',\n          size = .25) + \n  \n  wnomadds::scale_fill_rollcall() +\n  theme_minimal() +\n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        legend.position = 'none') # +\n\nmain1 + ggtitle(vra$short_description)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n## Zooming in to urban centers\n\nA zoom function for closer inspection of roll call results in urban areas. The `sub_geo` parameter is used to specify a vector of city/state pairs (eg, \"Chicago, Illinois\") to be geocoded via the `tmaptools::geocode_OSM` function. The `geo` parameter specifies the full map -- as `sf` object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaps_get_minis <- function(sub_geos, geo){\n                           \n  lapply(sub_geos, function(x) {\n    \n    lc <- tmaptools::geocode_OSM (q = x, as.sf = T)\n    lc$bbox <- sf::st_set_crs(lc$bbox, sf::st_crs(geo))\n    cropped <- sf::st_crop(geo, lc$bbox)\n    \n    ggplot() + geom_sf(data = cropped, \n                     aes(fill = Party_Member_Vote),\n                     color = 'white', size = .25) +\n      \n      # ggsflabel::geom_sf_text_repel(data = cropped, \n      #                               aes(label = district_code), \n      #                               size = 2.2) + \n      \n      wnomadds::scale_fill_rollcall() +\n      theme_minimal() + \n      theme(axis.title.x=element_blank(),\n            axis.text.x=element_blank(),\n            axis.title.y=element_blank(),\n            axis.text.y=element_blank(),\n            plot.title = element_text(size=9),\n            legend.position = 'none') +\n      ggtitle(gsub(',.*$', '', x))   })\n}\n```\n:::\n\n\n### Coordinates\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# x <- 'Albuquerque, New Mexico'\npops1 <- pops %>%\n  filter(decade == paste0(gsub('.-.*$', '', vra$date), 0)) %>%\n  arrange(desc(pop)) %>%\n  mutate(locations = paste0(city, ', ', state)) %>%\n  slice(1:10)\n\nsub_maps <- maps_get_minis(geo = cd_sf_w_rolls, sub_geos = pops1$locations)\n```\n:::\n\n\n### Zooms\n\nRoll call results for the VRA (1965) -- zoomed in to the ten most populous US cities during the 1960s.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npatchwork::wrap_plots(sub_maps, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n## A `patchwork` perspective\n\n\n::: {.cell}\n\n```{.r .cell-code}\nt2 <- gridExtra::tableGrob(summary, \n                           rows = NULL, \n                           theme = gridExtra::ttheme_minimal(base_size = 8)) \n\np0 <- sub_maps[[1]] + sub_maps[[2]] + sub_maps[[3]] +\n  rsum + patchwork::plot_layout(nrow = 1, widths = c(1,1,1,1))\n\np1 <- sub_maps[[4]] + sub_maps[[5]] + sub_maps[[6]] +\n  t2 + patchwork::plot_layout(nrow = 1, widths = c(1,1,1,1))\n\np2 <- p0/p1 + patchwork::plot_layout(nrow = 2)#, heights = c(4, 1))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmain1 / p2  + patchwork::plot_layout(ncol = 1, heights = c(5, 4)) +\n  plot_annotation(\n    title = vra$short_description, \n    subtitle = paste0('Congress ', vra$congress, ' | ',\n                             vra$date, ' | ', vra$bill_number, ' | ',\n                             'Support: ', round(vra$support, 1), '%'),\n     caption = 'Sources: VoteView | Polisci @ UCLA')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n------------------------------------------------------------------------\n\n## On the popular vote\n\nPer code above, we can create a simple & reproducible work-flow for quickly exploring historical roll calls in the US Congress. For the **Bayh--Celler amendment** (circa 1969), then, we (down-) load the congressional district shapefile for the 91st congress from UCLA, and re-query `RVoteview`.\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}